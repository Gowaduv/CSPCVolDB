 <h1>Listing events</h1>
<%  order = @listings.keys.sort %>
<%  order.each do |date| %>
  <div style="background: yellow;"><b><%= date %></b></div>
  <% @listings[date].each do |event| %>
      <% e = event[:event] %>
      <% schedules = Schedule.where(staff_id: e.staffs.map(&:id), date: event[:date].to_time) %>
      <div><b><%= event[:title] %></b></div>
      <table>
        <thead>
        <th></th>
        <th>STAFF</th>
        <th>START</th>
        <th>END</th>
        <th>DURATION</th>
        <th>CREDIT</th>
        <th>VOLUNTEER</th>
        <% if current_user.present? %>
        <th>Click below to:</th>
        <th>SHADOWS</th>
        <th>Click below to:</th>
        <% if can? :approve, Offer %>
        <th>Manage Offers</th>
        <% end %>
        <% end %>
        </thead>
        <tbody>        
      
      <% schedules.each do |s| %>
      <% ics = s.to_icecube %>
      <tr>
        <td></td>          
        <td><%= s.position.name %></td>
        <td><%= ics.start_time.strftime("%I:%M%p") %></td>
        <td><%= ics.end_time.strftime("%I:%M%p") %>
        <td><%= s.shift.duration %> minutes</td>
        <td><%= s.shift.credit %> minutes</td>
        <td><span id="schedule_user_<%= s.id %>"><%= s.accepted_offer.user.username if s.accepted_offer %></span></td>
        <% if current_user.present? %>
        <td><span id="schedule_offer_<%= s.id %>">
                <% if s.has_offer_from?(current_user) %>
                  <% if s.has_accepted_offer_from?(current_user) %>
                     <%= render 'offers/cancel', :s => s %>
                  <% elsif s.has_denied_offer_from?(current_user) then %>
                    Offer Denied.  Thank you for your offer.
                  <% else %>
                    <%= render 'offers/pending', :s => s %>
                  <% end %>                   
                <% else %>
                  <% if s.accepted_offer %>
                    <%= render 'offers/open_shift', :s => s %>
                  <% elsif current_user.qualified?(s.position.name) and ! s.has_denied_offer_from?(current_user) %> <!-- denied offers include revoked offers -->
                    <%= render 'offers/signup', :s => s %>
                  <% end %>                 
                <% end %>
               </span>
        </td>
        <% end %>
        <td></td> <!-- shadow name -->
        <td></td> <!-- shadow info -->
        <td>
          <span id="manage_offers_<%= s.id %>">
          <% if !s.accepted_offer and can? :approve, s.staff.event  %>
            <%= render 'offers/user_offers', :s => s %>
          <% end %>
          </span>
        </td>
      </tr>
      <% end %>
      </tbody>
      </table>
      <br />
    <% end %>   
  <% end %>
<br>

<% if can?(:create, Event) %><%= link_to 'New Event', new_event_path %><% end %>
